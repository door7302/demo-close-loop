services:
# InfluxDB service
  influxdb:
    image: influxdb:1.8
    container_name: influxdb
    restart: always
    user: root
    environment:
      - INFLUXDB_DB=demo
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin
    ports:
      - '8086:8086'
    volumes:
      - /var/log:/var/log
      - /opt/influxdb/influxdb.conf:/etc/influxdb/influxdb.conf
      - /opt/influxdb/data:/var/lib/influxdb
# Telegraf service 
  telegraf:
    build: https://github.com/door7302/jts_telegraf.git#v1.0.16
    image: jts_telegraf:latest
    container_name: jts_telegraf
    restart: always
    user: root
    depends_on:
      - influxdb
    volumes:
      - /var/log:/var/log
      - /opt/telegraf/:/etc/telegraf/
      - /opt/telegraf/metadata:/var/metadata
      - /opt/telegraf/cert:/var/cert
    command:
      --config-directory /etc/telegraf/telegraf.d
# Grafana service
  grafana:
    image: grafana/grafana:10.3.1
    container_name: grafana
    restart: always
    user: root
    depends_on:
      - influxdb
    ports:
      - '${GRAFANA_PORT}:3000'
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/home.json
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=yesoreyeram-boomtable-panel, agenty-flowcharting-panel
    volumes:
      - /opt/grafana/grafana.ini:/etc/grafana/grafana.ini
      - /opt/grafana/cert:/tmp
      - /opt/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - /opt/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - /opt/grafana/data:/var/lib/grafana
      - /opt/grafana/plugins:/var/lib/grafana/plugins
# Kafka service 
  kafka:
    image: confluentinc/cp-kafka:7.8.0
    container_name: kafka
    ports:
      - "9092:9092"
    user: root
    environment:
      KAFKA_KRAFT_MODE: "true"
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: EXTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: EXTERNAL
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://10.83.153.137:9092
      KAFKA_LOG_RETENTION_HOURS: 1
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      CLUSTER_ID: "d33bd245-a018-40a3-91b1-b82cf89d9e1c"
# StackSTORM services
  st2web:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2web:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    environment:
      ST2_AUTH_URL: ${ST2_AUTH_URL:-http://st2auth:9100/}
      ST2_API_URL: ${ST2_API_URL:-http://st2api:9101/}
      ST2_STREAM_URL: ${ST2_STREAM_URL:-http://st2stream:9102/}
      ST2WEB_HTTPS: ${ST2WEB_HTTPS:-0}
    depends_on:
      - st2auth
      - st2api
      - st2stream
    healthcheck:
      test: ["CMD", "/st2web-healthcheck.sh"]
      interval: 30s
      timeout: 1s
      retries: 1
    volumes:
      - /opt/stackstorm/scripts/st2web-healthcheck.sh:/st2web-healthcheck.sh
      # If you want to use a custom st2web config, edit /opt/stackstorm/files/config.js accordingly and
      # uncomment the line below
      #- /opt/stackstorm/files/config.js:/opt/stackstorm/static/webui/config.js:ro
    ports:
      - "${ST2_EXPOSE_HTTP:-127.0.0.1:80}:80"
      # - "${ST2_EXPOSE_HTTPS:-127.0.0.1:443}:443"
      # more work would be needed with certificate generate to make https work.
    networks:
      - private
      - public
  st2makesecrets:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2actionrunner:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    networks:
      - private
    volumes:
      - /opt/stackstorm/scripts/makesecrets.sh:/makesecrets.sh
      - stackstorm-keys:/etc/st2/keys:rw
    command: /makesecrets.sh
  st2api:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2api:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - mongo
      - rabbitmq
      - redis
      - st2makesecrets
    networks:
      - private
    environment:
      ST2_AUTH_URL: ${ST2_AUTH_URL:-http://st2auth:9100/}
      ST2_API_URL: ${ST2_API_URL:-http://st2api:9101/}
      ST2_STREAM_URL: ${ST2_STREAM_URL:-http://st2stream:9102/}
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
      - stackstorm-keys:/etc/st2/keys:ro
      - stackstorm-packs-configs:/opt/stackstorm/configs:rw
      - stackstorm-packs:/opt/stackstorm/packs:rw
      - /opt/stackstorm/files/rbac:/opt/stackstorm/rbac:rw
      - ${ST2_PACKS_DEV:-/opt/stackstorm/packs.dev}:/opt/stackstorm/packs.dev:rw
  st2stream:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2stream:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
  st2scheduler:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2scheduler:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - redis
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
  st2workflowengine:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2workflowengine:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - redis
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
      - stackstorm-keys:/etc/st2/keys:ro
  st2auth:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2auth:${ST2_VERSION:-latest}
    restart: on-failure
    depends_on:
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
      - /opt/stackstorm/files/htpasswd:/etc/st2/htpasswd:ro
  st2actionrunner:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2actionrunner:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - redis
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
      - stackstorm-packs-configs:/opt/stackstorm/configs:rw
      - stackstorm-packs:/opt/stackstorm/packs:rw
      - ${ST2_PACKS_DEV:-/opt/stackstorm/packs.dev}:/opt/stackstorm/packs.dev:rw
      - stackstorm-virtualenvs:/opt/stackstorm/virtualenvs:rw
      - stackstorm-ssh:/home/stanley/.ssh
      # Action runner needs access to keys since action definitions (Jinja
      # templates) can reference secrets
      - stackstorm-keys:/etc/st2/keys:ro
  st2garbagecollector:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2garbagecollector:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
  st2notifier:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2notifier:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - redis
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
  st2rulesengine:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2rulesengine:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
  st2sensorcontainer:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2sensorcontainer:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
      - stackstorm-virtualenvs:/opt/stackstorm/virtualenvs:ro
      - stackstorm-packs:/opt/stackstorm/packs:ro
      - stackstorm-packs-configs:/opt/stackstorm/configs:ro
      - ${ST2_PACKS_DEV:-/opt/stackstorm/packs.dev}:/opt/stackstorm/packs.dev:ro
  st2timersengine:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2timersengine:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - st2api
    networks:
      - private
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
  st2client:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2actionrunner:${ST2_VERSION:-latest}
    restart: on-failure
    user: root
    depends_on:
      - st2auth
      - st2api
      - st2stream
    command: /st2client-startup.sh
    networks:
      - private
    environment:
      ST2CLIENT: 1
      ST2_AUTH_URL: ${ST2_AUTH_URL:-http://st2auth:9100/}
      ST2_API_URL: ${ST2_API_URL:-http://st2api:9101/}
      ST2_STREAM_URL: ${ST2_STREAM_URL:-http://st2stream:9102/}
      TZ: ${TZ:-UTC}
    volumes:
      - /opt/stackstorm/files/st2.docker.conf:/etc/st2/st2.docker.conf:ro
      - /opt/stackstorm/files/st2.user.conf:/etc/st2/st2.user.conf:ro
      # Technically, client container doesn't need or should have access to the
      # keys in prod setup, but here we make it available to end user for
      # testing and transparency reasons since this setup is primarily mean to
      # be used for testing and development.
      - stackstorm-keys:/etc/st2/keys:ro
      - stackstorm-packs-configs:/opt/stackstorm/configs:rw
      - stackstorm-packs:/opt/stackstorm/packs:rw
      - /opt/stackstorm/files/rbac:/opt/stackstorm/rbac:rw
      - ${ST2_PACKS_DEV:-/opt/stackstorm/packs.dev}:/opt/stackstorm/packs.dev:rw
      - /opt/stackstorm/files/st2-cli.conf:/root/.st2/config
      - /opt/stackstorm/scripts/st2client-startup.sh:/st2client-startup.sh
  st2chatops:
    image: ${ST2_IMAGE_REPO:-stackstorm/}st2chatops:${ST2_VERSION:-latest}
    restart: on-failure:5
    user: root
    depends_on:
      - st2api
      - st2auth
      - st2stream
    command: /st2chatops-startup.sh
    networks:
      - private
    environment:
      ST2_AUTH_URL: ${ST2_AUTH_URL:-http://st2auth:9100/}
      ST2_API_URL: ${ST2_API_URL:-http://st2api:9101/}
      ST2_STREAM_URL: ${ST2_STREAM_URL:-http://st2stream:9102/}
      ST2_API_KEY: ${ST2_API_KEY:-change-to-your-st2-api-key}
      TZ: ${TZ:-UTC}
      # enable chatops by setting this variable to any non-zero value
      # and enable/set your hubot adapter specific variables below
      ST2_CHATOPS_ENABLE: ${ST2_CHATOPS_ENABLE:-0}
      # Custom hubot adapter ENV variables to pass through which will override st2chatops.env defaults.
      # See https://github.com/StackStorm/st2chatops/blob/master/st2chatops.env
      # for the full list of supported adapters and example ENV variables.
      HUBOT_ADAPTER: ${HUBOT_ADAPTER:-slack}
      HUBOT_LOG_LEVEL: ${HUBOT_LOG_LEVEL:-debug}
      HUBOT_SLACK_TOKEN: ${HUBOT_SLACK_TOKEN:-}
    volumes:
      - /opt/stackstorm/scripts/st2chatops-startup.sh:/st2chatops-startup.sh
  # external services
  mongo:
    image: mongo:4.4
    restart: on-failure
    networks:
      - private
    volumes:
      - stackstorm-mongodb:/data/db
  rabbitmq:
    image: rabbitmq:3.12
    restart: on-failure
    networks:
      - private
    volumes:
      - stackstorm-rabbitmq:/var/lib/rabbitmq
  redis:
    image: redis:7.2
    restart: on-failure
    networks:
      - private
    volumes:
      - stackstorm-redis:/data

volumes:
    stackstorm-mongodb:
    stackstorm-rabbitmq:
    stackstorm-redis:
    stackstorm-packs:
    stackstorm-packs-configs:
    stackstorm-keys:
    stackstorm-virtualenvs:
    stackstorm-ssh:

networks:
  public:
    driver: bridge
  private:
    driver: bridge